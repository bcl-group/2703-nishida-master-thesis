## 粘性減衰を含む 2リンクアームの運動方程式と前進ダイナミクス

2リンク平面アームの運動方程式を
$$
\begin{equation}
M(\theta)\,\ddot{\theta}
+ C(\theta,\dot{\theta})\,\dot{\theta}
+ G(\theta)
= \tau
\end{equation}
$$
という標準形で得たとする．ここで
- $\theta = \begin{bmatrix}\theta_1 \\ \theta_2\end{bmatrix}$：関節角ベクトル
- $\dot{\theta},\ddot{\theta}$：その時間微分
- $M(\theta)\in\mathbb{R}^{2\times 2}$：慣性行列（対称・正定値）
- $C(\theta,\dot{\theta})\dot{\theta}\in\mathbb{R}^2$：コリオリ・遠心項ベクトル
- $G(\theta)\in\mathbb{R}^2$：重力トルクベクトル
- $\tau\in\mathbb{R}^2$：関節トルクベクトル（制御入力）
である．


## 粘性減衰トルクのモデル

関節 $i$ に粘性減衰（viscous damping）が存在する場合，関節速度に比例した減衰トルク
$$
\tau_{d,i} = -b_i\,\dot{\theta}_i
$$
が働くとモデル化する（$b_i>0$ は粘性係数）．2リンクの場合は
$$
\tau_d
=
\begin{bmatrix}
\tau_{d,1}\\[2pt]
\tau_{d,2}
\end{bmatrix}
=
-
\begin{bmatrix}
b_1 & 0\\[2pt]
0 & b_2
\end{bmatrix}
\begin{bmatrix}
\dot{\theta}_1\\[2pt]
\dot{\theta}_2
\end{bmatrix}
=
- B\,\dot{\theta},
$$
と書ける．ここで
$$
B
=
\begin{bmatrix}
b_1 & 0\\
0 & b_2
\end{bmatrix}
$$
を粘性減衰係数の対角行列とした．（必要なら非対角成分を持つより一般的な $B$ も考えられる．）


## 粘性減衰を含めた運動方程式

粘性減衰を考慮した場合の関節トルクの釣り合いは
$$
\text{(慣性)} + \text{(コリオリ・遠心)} + \text{(重力)} + \text{(粘性減衰)}
= \text{(駆動トルク)}
$$
となるので，
$$
\begin{equation}
M(\theta)\,\ddot{\theta}
+ C(\theta,\dot{\theta})\,\dot{\theta}
+ G(\theta)
+ B\,\dot{\theta}
= \tau
\end{equation}
$$
と書ける．

右辺を「駆動トルク」，左辺を「系が要求するトルク」とみなすと，
粘性減衰 $B\dot{\theta}$ は常に速度の向きと逆向きに働き，関節の運動を減衰させる役割を持つことがわかる．


## 前進ダイナミクスの導出（一般形）

前進ダイナミクスとは，
$$
(\theta,\dot{\theta},\tau) \ \longmapsto\ \ddot{\theta}
$$
を求める写像であり，数値積分により関節運動を時間発展させるための基本式になる．

式 (2)を
$\ddot{\theta}$ について解くために，まずすべての「$\ddot{\theta}$ を含まない項」を右辺に移項すると，
$$
\begin{align}
M(\theta)\,\ddot{\theta}
&= \tau
   - C(\theta,\dot{\theta})\,\dot{\theta}
   - G(\theta)
   - B\,\dot{\theta}.
\end{align}
$$
ここで右辺をまとめて
$$
h(\theta,\dot{\theta},\tau)
=
\tau - C(\theta,\dot{\theta})\,\dot{\theta} - G(\theta) - B\,\dot{\theta}
$$
とおけば，
$$
\begin{equation}
M(\theta)\,\ddot{\theta} = h(\theta,\dot{\theta},\tau)
\end{equation}
$$
となる．慣性行列 $M(\theta)$ は正定値であり，したがって可逆なので，
$$
\ddot{\theta}
= M(\theta)^{-1}\,h(\theta,\dot{\theta},\tau)
$$
と書ける．すなわち，
$$
\begin{equation}
\boxed{
\ddot{\theta}
=
M(\theta)^{-1}
\Bigl[
  \tau
  - C(\theta,\dot{\theta})\,\dot{\theta}
  - G(\theta)
  - B\,\dot{\theta}
\Bigr]
}
\end{equation}
$$
が，粘性減衰を含んだ 2リンクアームの前進ダイナミクスである．


##  2×2 慣性行列の具体的な成分表示

2リンクアームの場合，慣性行列は
$$
M(\theta)
=
\begin{bmatrix}
M_{11}(\theta_2) & M_{12}(\theta_2)\\[3pt]
M_{21}(\theta_2) & M_{22}
\end{bmatrix}
$$
であり，対称性から $M_{12}=M_{21}$ が成り立つ．

粘性・コリオリ・重力・入力トルクをまとめた右辺ベクトルを
$$
r(\theta,\dot{\theta},\tau)
=
\begin{bmatrix}
r_1\\[2pt]
r_2
\end{bmatrix}
=
\tau
- C(\theta,\dot{\theta})\,\dot{\theta}
- G(\theta)
- B\,\dot{\theta}
$$
とおくと，
$$
M(\theta)\,\ddot{\theta} = r(\theta,\dot{\theta},\tau)
$$
は成分で書くと
$$
\begin{align}
M_{11}\ddot{\theta}_1 + M_{12}\ddot{\theta}_2 &= r_1,\\
M_{21}\ddot{\theta}_1 + M_{22}\ddot{\theta}_2 &= r_2.
\end{align}
$$

この 2元連立一次方程式を解くために，$M$ の逆行列を計算する．行列の行列式を
$$
\Delta(\theta_2) = \det M(\theta)
= M_{11}M_{22} - M_{12}^2
$$
とすると，
$$
M(\theta)^{-1}
=
\frac{1}{\Delta(\theta_2)}
\begin{bmatrix}
M_{22} & -M_{12}\\[3pt]
-M_{21} & M_{11}
\end{bmatrix}
=
\frac{1}{\Delta(\theta_2)}
\begin{bmatrix}
M_{22} & -M_{12}\\[3pt]
-M_{12} & M_{11}
\end{bmatrix}.
$$

したがって，
$$
\begin{equation}
\ddot{\theta}
=
\begin{bmatrix}
\ddot{\theta}_1\\[2pt]
\ddot{\theta}_2
\end{bmatrix}
=
M(\theta)^{-1}
\begin{bmatrix}
r_1\\[2pt]
r_2
\end{bmatrix}
=
\frac{1}{\Delta(\theta_2)}
\begin{bmatrix}
M_{22} r_1 - M_{12} r_2\\[3pt]
- M_{12} r_1 + M_{11} r_2
\end{bmatrix}.
\end{equation}
$$
ここで $r_1,r_2$ は
$$
\begin{align}
r_1
&= \tau_1
   - \bigl[C(\theta,\dot{\theta})\dot{\theta}\bigr]_1
   - G_1(\theta)
   - b_1\dot{\theta}_1,
\\
r_2
&= \tau_2
   - \bigl[C(\theta,\dot{\theta})\dot{\theta}\bigr]_2
   - G_2(\theta)
   - b_2\dot{\theta}_2,
\end{align}
$$
と書ける（$[\cdot]_i$ はベクトルの $i$ 成分）．

##  状態方程式としてのまとめ（数値シミュレーション用）

状態ベクトルを
$$
x =
\begin{bmatrix}
\theta_1\\
\theta_2\\
\dot{\theta}_1\\
\dot{\theta}_2
\end{bmatrix}
$$
とし，入力を $\tau = [\tau_1\;\;\tau_2]^\top$ とすると，
前進ダイナミクス を用いて
$$
\dot{x}
=
\begin{bmatrix}
\dot{\theta}_1\\
\dot{\theta}_2\\
\ddot{\theta}_1\\
\ddot{\theta}_2
\end{bmatrix}
=
\begin{bmatrix}
\dot{\theta}_1\\
\dot{\theta}_2\\[3pt]
\bigl[\ddot{\theta}_1(\theta,\dot{\theta},\tau)\bigr]\\
\bigl[\ddot{\theta}_2(\theta,\dot{\theta},\tau)\bigr]
\end{bmatrix}
$$
という常微分方程式（状態方程式）が得られる．

この形にしておけば，オイラー法やRunge–Kutta法などの数値積分器を用いて，粘性減衰を含む 2リンクアームの時間応答シミュレーションを行うことができる．
