# ２リンクアームの運動方程式の導出
## パラメータと座標系の定義
![アーム](png/強化学習.pdf.002.jpeg)
2リンク平面アームを，平面内（$x$–$y$ 平面）で回転する 2 つの剛体リンクとしてモデル化する．
- リンク1の長さ：$l_1$, リンク2の長さ：$l_2$
- リンク1の質量：$m_1$, リンク2の質量：$m_2$
- リンク1の重心までの距離：$l_{c1}$（関節1からリンク1重心まで）, リンク2の重心までの距離：$l_{c2}$（関節2からリンク2重心まで）
- リンク1の重心まわり慣性モーメント：$I_1$, リンク2の重心まわり慣性モーメント：$I_2$
- 関節角：$\theta_1,\ \theta_2$（反時計回り正）

ベクトル表記での重心位置は
$$
\begin{align}
\mathbf{r}_{c1}
&=
\begin{bmatrix}
  x_{c1} \\[3pt]
  y_{c1}
\end{bmatrix}
=
\begin{bmatrix}
  l_{c1}\cos\theta_1 \\
  l_{c1}\sin\theta_1
\end{bmatrix},
\\[4pt]
\mathbf{r}_{c2}
&=
\begin{bmatrix}
  x_{c2} \\[3pt]
  y_{c2}
\end{bmatrix}
=
\begin{bmatrix}
  l_1\cos\theta_1 + l_{c2}\cos(\theta_1+\theta_2) \\
  l_1\sin\theta_1 + l_{c2}\sin(\theta_1+\theta_2)
\end{bmatrix}.
\end{align}
$$

## 重心速度の計算

時間微分により各重心の速度を求める：
$$
\begin{align}
\dot{x}_{c1} &= -l_{c1}\sin\theta_1\,\dot{\theta}_1, \\
\dot{y}_{c1} &=  l_{c1}\cos\theta_1\,\dot{\theta}_1,
\\[4pt]
\dot{x}_{c2} &= -l_1\sin\theta_1\,\dot{\theta}_1
               -l_{c2}\sin(\theta_1+\theta_2)(\dot{\theta}_1+\dot{\theta}_2),\\
\dot{y}_{c2} &=  l_1\cos\theta_1\,\dot{\theta}_1
               +l_{c2}\cos(\theta_1+\theta_2)(\dot{\theta}_1+\dot{\theta}_2).
\end{align}
$$

各重心の速度ノルムの二乗は(三平方の定理)
$$
\begin{align}
v_{c1}^2 &= \dot{x}_{c1}^2 + \dot{y}_{c1}^2
= l_{c1}^2 \dot{\theta}_1^2,
\\[4pt]
v_{c2}^2 &= \dot{x}_{c2}^2 + \dot{y}_{c2}^2.
\end{align}
$$
$v_{c2}^2$ を展開すると
$$
\begin{align}
v_{c2}^2
&=
\bigl(-l_1\sin\theta_1\,\dot{\theta}_1
      -l_{c2}\sin(\theta_1+\theta_2)(\dot{\theta}_1+\dot{\theta}_2)\bigr)^2 \notag\\
&\quad+
\bigl( l_1\cos\theta_1\,\dot{\theta}_1
      +l_{c2}\cos(\theta_1+\theta_2)(\dot{\theta}_1+\dot{\theta}_2)\bigr)^2.
\end{align}
$$
$\sin^2 + \cos^2 = 1$ とクロスタームの整理により，標準的な形
$$
\begin{align}
v_{c2}^2
&=
\bigl(l_1^2 + l_{c2}^2 + 2 l_1 l_{c2}\cos\theta_2\bigr)\dot{\theta}_1^2
+ l_{c2}^2 \dot{\theta}_2^2
+ 2\bigl(l_1 l_{c2}\cos\theta_2 + l_{c2}^2\bigr)\dot{\theta}_1\dot{\theta}_2
\end{align}
$$
が得られる．ここで $\theta_2$ のみが相対角として現れている点に注意する．

## 運動エネルギー $T$ の導出と慣性行列

リンク $i$ の運動エネルギーは
$$
T_i = \frac{1}{2} m_i v_{ci}^2 + \frac{1}{2} I_i \dot{\theta}_i^2
$$
である．したがって全体の運動エネルギーは
$$
\begin{align}
T &= T_1 + T_2 \notag\\
  &= \frac{1}{2}m_1 l_{c1}^2 \dot{\theta}_1^2 + \frac{1}{2}I_1 \dot{\theta}_1^2
   + \frac{1}{2}m_2 v_{c2}^2 + \frac{1}{2}I_2 (\dot{\theta}_1+\dot{\theta}_2)^2.
\end{align}
$$

$v_{c2}^2$ を先ほどの結果で代入・整理すると，
$$
T = \frac{1}{2}
\left(
M_{11}\dot{\theta}_1^2
+ 2M_{12}\dot{\theta}_1\dot{\theta}_2
+ M_{22}\dot{\theta}_2^2
\right)
$$
という 2 次形式で書ける．慣性行列 $M(\theta)$ の成分は
$$
\begin{align}
M_{11} &= m_1 l_{c1}^2 + I_1
       + m_2 \bigl(l_1^2 + l_{c2}^2 + 2l_1 l_{c2}\cos\theta_2 \bigr) + I_2,
\\
M_{12} &= m_2 \bigl(l_{c2}^2 + l_1 l_{c2}\cos\theta_2 \bigr) + I_2,
\\
M_{22} &= m_2 l_{c2}^2 + I_2.
\end{align}
$$

しばしば定数
$$
\begin{align}
a &= m_1 l_{c1}^2 + I_1 + m_2(l_1^2 + l_{c2}^2) + I_2,\\
b &= m_2 l_1 l_{c2},\\
d &= m_2 l_{c2}^2 + I_2
\end{align}
$$
を用いると，2リンクアームの運動エネルギーは
$$
\begin{align}
T(\theta,\dot{\theta})
&=
\frac{1}{2}
\left(
M_{11}\dot{\theta}_1^2
+ 2M_{12}\dot{\theta}_1\dot{\theta}_2
+ M_{22}\dot{\theta}_2^2
\right)
\\
&=
\frac{1}{2}
\bigl(a + 2b\cos\theta_2\bigr)\dot{\theta}_1^2
+ \bigl(d + b\cos\theta_2\bigr)\dot{\theta}_1\dot{\theta}_2
+ \frac{1}{2}d\,\dot{\theta}_2^2
\end{align}
$$
となる．

$$
M(\theta) =
\begin{bmatrix}
a + 2b\cos\theta_2 & d + b\cos\theta_2\\
d + b\cos\theta_2 & d
\end{bmatrix}
$$

##  $\dfrac{\partial T}{\partial \dot{\theta}_i}$ とその時間微分

まず速度での偏微分を計算すると
$$
\begin{align}
\frac{\partial T}{\partial \dot{\theta}_1}
&= M_{11}\dot{\theta}_1 + M_{12}\dot{\theta}_2
 = \bigl(a + 2b\cos\theta_2\bigr)\dot{\theta}_1
   + \bigl(d + b\cos\theta_2\bigr)\dot{\theta}_2,
\\[4pt]
\frac{\partial T}{\partial \dot{\theta}_2}
&= M_{12}\dot{\theta}_1 + M_{22}\dot{\theta}_2
 = \bigl(d + b\cos\theta_2\bigr)\dot{\theta}_1
   + d\,\dot{\theta}_2.
\end{align}
$$

これを時間微分する．$\theta_2$ に依存する係数の微分に注意する：

### 第1式の時間微分
$$
\begin{align}
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_1}\right)
&= \frac{d}{dt}\Bigl[(a + 2b\cos\theta_2)\dot{\theta}_1
                     + (d + b\cos\theta_2)\dot{\theta}_2\Bigr]
\\
&= (a + 2b\cos\theta_2)\ddot{\theta}_1
   + (d + b\cos\theta_2)\ddot{\theta}_2
\\
&\quad
   + \frac{d}{dt}(a + 2b\cos\theta_2)\,\dot{\theta}_1
   + \frac{d}{dt}(d + b\cos\theta_2)\,\dot{\theta}_2.
\end{align}
$$
ここで $a,d$ は定数，$\cos\theta_2$ の時間微分は
$$
\frac{d}{dt}\cos\theta_2 = -\sin\theta_2\,\dot{\theta}_2
$$
なので，
$$
\begin{align}
\frac{d}{dt}(a + 2b\cos\theta_2)
&= 2b\,\frac{d}{dt}(\cos\theta_2)
 = -2b\sin\theta_2\,\dot{\theta}_2,\\
\frac{d}{dt}(d + b\cos\theta_2)
&= b\,\frac{d}{dt}(\cos\theta_2)
 = -b\sin\theta_2\,\dot{\theta}_2.
\end{align}
$$
したがって
$$
\begin{align}
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_1}\right)
&= M_{11}\ddot{\theta}_1 + M_{12}\ddot{\theta}_2
\\
&\quad
   -2b\sin\theta_2\,\dot{\theta}_2\,\dot{\theta}_1
   -b\sin\theta_2\,\dot{\theta}_2\,\dot{\theta}_2
\\
&= M_{11}\ddot{\theta}_1 + M_{12}\ddot{\theta}_2
   -b\sin\theta_2\bigl(2\dot{\theta}_1\dot{\theta}_2 + \dot{\theta}_2^2\bigr).
\end{align}
$$

### 第2式の時間微分

同様に，
$$
\begin{align}
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_2}\right)
&= \frac{d}{dt}\Bigl[(d + b\cos\theta_2)\dot{\theta}_1 + d\,\dot{\theta}_2\Bigr]
\\
&= (d + b\cos\theta_2)\ddot{\theta}_1 + d\,\ddot{\theta}_2
   + \frac{d}{dt}(d + b\cos\theta_2)\,\dot{\theta}_1
\\
&= M_{21}\ddot{\theta}_1 + M_{22}\ddot{\theta}_2
   -b\sin\theta_2\,\dot{\theta}_2\,\dot{\theta}_1
\\
&= M_{21}\ddot{\theta}_1 + M_{22}\ddot{\theta}_2
   -b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2.
\end{align}
$$

###  $\dfrac{\partial T}{\partial \theta_i}$ の計算

$T$ は $\theta_2$ のみに（$\cos\theta_2$ を通して）依存するので，
$$
\frac{\partial T}{\partial \theta_1} = 0
$$
である．

一方，
$$
\begin{align}
T
&=
\frac{1}{2}
\bigl(a + 2b\cos\theta_2\bigr)\dot{\theta}_1^2
+ \bigl(d + b\cos\theta_2\bigr)\dot{\theta}_1\dot{\theta}_2
+ \frac{1}{2}d\,\dot{\theta}_2^2
\end{align}
$$
を $\theta_2$ で偏微分すると，
$$
\begin{align}
\frac{\partial T}{\partial \theta_2}
&=
\frac{1}{2}\cdot 2b(-\sin\theta_2)\,\dot{\theta}_1^2
 + b(-\sin\theta_2)\,\dot{\theta}_1\dot{\theta}_2
\\
&= -b\sin\theta_2\,\dot{\theta}_1^2
    -b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2.
\end{align}
$$
したがって
$$
\begin{align}
\frac{\partial T}{\partial \theta_1} &= 0,\\
\frac{\partial T}{\partial \theta_2}
&= -b\sin\theta_2\,\dot{\theta}_1^2
   -b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2.
\end{align}
$$

## ラグランジュ方程式と $C(\theta,\dot{\theta})\dot{\theta}$ の抽出

ラグランジアン $L = T - V$ を用いたラグランジュ方程式は
$$
\frac{d}{dt}\left(\frac{\partial L}{\partial \dot{\theta}_i}\right)
-
\frac{\partial L}{\partial \theta_i}
= \tau_i
\quad (i=1,2)
$$
であり，
$$
\frac{\partial L}{\partial \dot{\theta}_i}
= \frac{\partial T}{\partial \dot{\theta}_i},\qquad
\frac{\partial L}{\partial \theta_i}
= \frac{\partial T}{\partial \theta_i}
  - \frac{\partial V}{\partial \theta_i}
$$
なので，
$$
\begin{align}
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_i}\right)
- \frac{\partial T}{\partial \theta_i}
+ \frac{\partial V}{\partial \theta_i}
= \tau_i.
\end{align}
$$
ここで，
- $\ddot{\theta}$ を含む項 $\;\Rightarrow\; M(\theta)\ddot{\theta}$（慣性項）
- $\dot{\theta}$ のみを含む項 $\;\Rightarrow\; C(\theta,\dot{\theta})\dot{\theta}$（コリオリ・遠心項）
- $\theta$ のみを含む項 $\;\Rightarrow\; G(\theta)$（重力トルク）
と分類する．

まず $i=1$ の式では
$$
\frac{\partial T}{\partial \theta_1} = 0
$$
なので，
$$
\begin{align}
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_1}\right)
+ \frac{\partial V}{\partial \theta_1}
= \tau_1
\end{align}
$$
となる．このうち，
$$
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_1}\right)
= M_{11}\ddot{\theta}_1 + M_{12}\ddot{\theta}_2
   -b\sin\theta_2\bigl(2\dot{\theta}_1\dot{\theta}_2 + \dot{\theta}_2^2\bigr)
$$
であり，加速度項 $M_{11}\ddot{\theta}_1 + M_{12}\ddot{\theta}_2$ を除いた
$$
-b\sin\theta_2\bigl(2\dot{\theta}_1\dot{\theta}_2 + \dot{\theta}_2^2\bigr)
$$
が $C(\theta,\dot{\theta})\dot{\theta}$ の第1成分となる．

次に $i=2$ の式では
$$
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_2}\right)
- \frac{\partial T}{\partial \theta_2}
+ \frac{\partial V}{\partial \theta_2}
= \tau_2.
$$
ここで
$$
\begin{align}
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_2}\right)
&= M_{21}\ddot{\theta}_1 + M_{22}\ddot{\theta}_2
   -b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2,
\\
\frac{\partial T}{\partial \theta_2}
&= -b\sin\theta_2\,\dot{\theta}_1^2
   -b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2.
\end{align}
$$
したがって，加速度項を除いた速度のみの項は
$$
\begin{align}
&\Bigl[-b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2\Bigr]
-
\Bigl[-b\sin\theta_2\,\dot{\theta}_1^2
      -b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2\Bigr]
\\
&\qquad=
-b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2
+ b\sin\theta_2\,\dot{\theta}_1^2
+ b\sin\theta_2\,\dot{\theta}_1\dot{\theta}_2
\\
&\qquad=
b\sin\theta_2\,\dot{\theta}_1^2.
\end{align}
$$
これが $C(\theta,\dot{\theta})\dot{\theta}$ の第2成分となる．

以上より，コリオリ・遠心項ベクトルは
$$
C(\theta,\dot{\theta})\dot{\theta}
=
\begin{bmatrix}
-b\sin\theta_2\,(2\dot{\theta}_1\dot{\theta}_2 + \dot{\theta}_2^2)\\[3pt]
\phantom{-}b\sin\theta_2\,\dot{\theta}_1^2
\end{bmatrix}
$$
と整理できる．

## ポテンシャルエネルギーと重力トルク $G(\theta)$

重力加速度を $g$ （下向き）とし，$y$ を鉛直上向きとすると，重心の $y$ 座標は
$$
\begin{align}
y_{c1} &= l_{c1}\sin\theta_1,\\
y_{c2} &= l_1\sin\theta_1 + l_{c2}\sin(\theta_1+\theta_2)
\end{align}
$$
であるから，ポテンシャルエネルギーは
$$
\begin{align}
V(\theta)
&= m_1 g y_{c1} + m_2 g y_{c2}
\\
&= m_1 g l_{c1}\sin\theta_1
 + m_2 g \bigl(l_1\sin\theta_1 + l_{c2}\sin(\theta_1+\theta_2)\bigr).
\end{align}
$$
各関節角で偏微分すると，
$$
\begin{align}
\frac{\partial V}{\partial \theta_1}
&= m_1 g l_{c1}\cos\theta_1
 + m_2 g \bigl(l_1\cos\theta_1 + l_{c2}\cos(\theta_1+\theta_2)\bigr)
\\
&= (m_1 l_{c1} + m_2 l_1)g\cos\theta_1
 + m_2 l_{c2} g\cos(\theta_1+\theta_2),
\\[4pt]
\frac{\partial V}{\partial \theta_2}
&= m_2 g l_{c2}\cos(\theta_1+\theta_2).
\end{align}
$$
ラグランジュ方程式の形
$$
\frac{d}{dt}\left(\frac{\partial T}{\partial \dot{\theta}_i}\right)
- \frac{\partial T}{\partial \theta_i}
+ \frac{\partial V}{\partial \theta_i}
= \tau_i
$$
と比較すると，重力トルクベクトル $G(\theta)$ は
$$
G(\theta) =
\begin{bmatrix}
\displaystyle
(m_1 l_{c1} + m_2 l_1)g\cos\theta_1
+ m_2 l_{c2} g\cos(\theta_1+\theta_2)
\\[6pt]
\displaystyle
m_2 l_{c2} g\cos(\theta_1+\theta_2)
\end{bmatrix}
$$
と書ける．
（$\sin$ で表現するか $\cos$ で表現するかは，基準角度や座標の取り方によって変わる．）

## 最終的な標準形

以上をまとめると，2リンクアームの運動方程式は
$$
\boxed{
M(\theta)\ddot{\theta}
+ C(\theta,\dot{\theta})\dot{\theta}
+ G(\theta)
= \tau
}
$$
という標準形に整理できる．



